import{create_object}from"../common.js";import Index,{autoCommit}from"../index.js";import default_compress from"../compress.js";import{KeystoreArray}from"../keystore.js";Index.prototype.add=function(a,b,c,d){if(b&&(a||0===a)){if(!d&&!c&&this.reg.has(a))return this.update(a,b);const e=this.depth;b=this.encoder.encode(b,!e);const f=b.length;if(f){const d=create_object(),g=create_object(),h=this.resolution;for(let j=0;j<f;j++){let i=b[this.rtl?f-1-j:j],k=i.length;if(k&&(e||!g[i])){let l=this.score?this.score(b,i,j,null,0):get_score(h,f,j),m="";switch(this.tokenize){case"full":if(2<k){for(let d,e=0;e<k;e++)for(let l=k;l>e;l--){m=i.substring(e,l),d=this.rtl?k-1-e:e;const n=this.score?this.score(b,i,j,m,d):get_score(h,f,j,k,d);this.push_index(g,m,n,a,c)}break}case"bidirectional":case"reverse":if(1<k){for(let d=k-1;0<d;d--){m=i[this.rtl?k-1-d:d]+m;const e=this.score?this.score(b,i,j,m,d):get_score(h,f,j,k,d);this.push_index(g,m,e,a,c)}m=""}case"forward":if(1<k){for(let b=0;b<k;b++)m+=i[this.rtl?k-1-b:b],this.push_index(g,m,l,a,c);break}default:if(this.push_index(g,i,l,a,c),e&&1<f&&j<f-1){const g=create_object(),h=this.resolution_ctx,k=i,l=Math.min(e+1,this.rtl?j+1:f-j);g[k]=1;for(let e=1;e<l;e++)if(i=b[this.rtl?f-1-j-e:j+e],i&&!g[i]){g[i]=1;const m=this.score?this.score(b,k,j,i,e-1):get_score(h+(f/2>h?0:1),f,j,l-1,e-1),n=this.bidirectional&&i>k;this.push_index(d,n?k:i,m,a,c,n?i:k)}}}}}this.fastupdate||this.reg.add(a)}else b=""}return this.db&&(b||this.commit_task.push({del:a}),this.commit_auto&&autoCommit(this)),this},Index.prototype.push_index=function(a,b,c,d,e,f){let g,h=f?this.ctx:this.map;if((!a[b]||f&&!(g=a[b])[f])&&(f?(a=g||(a[b]=create_object()),a[f]=1,this.compress&&(f=default_compress(f)),g=h.get(f),g?h=g:h.set(f,h=new Map)):a[b]=1,this.compress&&(b=default_compress(b)),g=h.get(b),g?h=g:h.set(b,h=g=[]),h=h[c]||(h[c]=[]),!e||!h.includes(d))){if(2147483647===h.length){const a=new KeystoreArray(h);if(this.fastupdate)for(let b of this.reg.values())b.includes(h)&&(b[b.indexOf(h)]=a);g[c]=h=a}if(h.push(d),this.fastupdate){const a=this.reg.get(d);a?a.push(h):this.reg.set(d,[h])}}};function get_score(a,b,c,d,e){return c&&1<a?b+(d||0)<=a?c+(e||0):0|(a-1)/(b+(d||0))*(c+(e||0))+1:0}